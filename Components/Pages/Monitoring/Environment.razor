@page "/monitoring/environment"
@using manufacturing_system.Data
@using manufacturing_system.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IWeatherService WeatherService
@inject ApplicationDbContext DbContext
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<PageTitle>NodeSync | Environment Monitoring</PageTitle>

<div class="page-header mb-4">
    <h1>Environment Monitoring</h1>
    <p class="mb-0 opacity-75">Real-time temperature and humidity readings</p>
</div>

<div class="row g-4">
    @if (isLoading)
    {
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Fetching weather data...</p>
        </div>
    }
    else if (weatherData != null)
    {
        <div class="col-lg-4">
            <div class="environment-card temperature-card">
                <div class="card-icon">
                    <i class="bi bi-thermometer-half"></i>
                </div>
                <div class="card-content">
                    <span class="card-label">Temperature</span>
                    <span class="card-value">@weatherData.Temperature.ToString("F1")°C</span>
                    <span class="card-sublabel">Feels like @weatherData.FeelsLike.ToString("F1")°C</span>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="environment-card humidity-card">
                <div class="card-icon">
                    <i class="bi bi-droplet-half"></i>
                </div>
                <div class="card-content">
                    <span class="card-label">Humidity</span>
                    <span class="card-value">@weatherData.Humidity%</span>
                    <span class="card-sublabel">Pressure: @weatherData.Pressure hPa</span>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="environment-card status-card @GetStatusClass()">
                <div class="card-icon">
                    <i class="bi @GetStatusIcon()"></i>
                </div>
                <div class="card-content">
                    <span class="card-label">Alert Status</span>
                    <span class="card-value">@weatherData.GetAlertStatus()</span>
                    <span class="card-sublabel">Wind: @weatherData.WindSpeed m/s</span>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                        <div class="d-flex align-items-center gap-3">
                            <img src="@weatherData.IconUrl" alt="Weather" class="weather-icon" />
                            <div>
                                <h4 class="mb-1">@weatherData.Location, @weatherData.Country</h4>
                                <p class="mb-0 text-muted text-capitalize">@weatherData.Description</p>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" @onclick="RefreshWeather" disabled="@isLoading">
                                <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                            </button>
                            <button class="btn btn-outline-primary" @onclick="LogReading" disabled="@isLoading">
                                <i class="bi bi-database-add me-2"></i>Log Reading
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="col-12">
                <div class="alert @(statusMessage.Contains("Error") ? "alert-danger" : "alert-success") alert-dismissible fade show">
                    @statusMessage
                    <button type="button" class="btn-close" @onclick="@(() => statusMessage = "")"></button>
                </div>
            </div>
        }

        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Readings</h5>
                </div>
                <div class="card-body">
                    @if (recentReadings.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Date/Time</th>
                                        <th>Temperature</th>
                                        <th>Humidity</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var reading in recentReadings)
                                    {
                                        <tr>
                                            <td>@reading.RecordedDate.ToString("MMM dd, yyyy HH:mm")</td>
                                            <td>@reading.Temperature.ToString("F1")°C</td>
                                            <td>@reading.Humidity%</td>
                                            <td>
                                                <span class="badge @GetBadgeClass(reading.AlertStatus)">@reading.AlertStatus</span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center py-3 mb-0">No readings logged yet. Click "Log Reading" to save the current data.</p>
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="col-12">
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Unable to fetch weather data. Please check your internet connection and try again.
                <button class="btn btn-sm btn-warning ms-3" @onclick="RefreshWeather">Retry</button>
            </div>
        </div>
    }
</div>

<style>
    .environment-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 1.5rem;
        color: white;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .environment-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
    }

    .temperature-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        box-shadow: 0 10px 30px rgba(245, 87, 108, 0.3);
    }

    .humidity-card {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        box-shadow: 0 10px 30px rgba(79, 172, 254, 0.3);
    }

    .status-card.status-normal {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        box-shadow: 0 10px 30px rgba(56, 239, 125, 0.3);
    }

    .status-card.status-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5af19 100%);
        box-shadow: 0 10px 30px rgba(245, 175, 25, 0.3);
    }

    .status-card.status-critical {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        box-shadow: 0 10px 30px rgba(235, 51, 73, 0.3);
    }

    .card-icon {
        width: 60px;
        height: 60px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
    }

    .card-content {
        display: flex;
        flex-direction: column;
    }

    .card-label {
        font-size: 0.875rem;
        opacity: 0.9;
    }

    .card-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1.2;
    }

    .card-sublabel {
        font-size: 0.75rem;
        opacity: 0.8;
    }

    .weather-icon {
        width: 64px;
        height: 64px;
    }
</style>

@code {
    private WeatherData? weatherData;
    private bool isLoading = true;
    private string statusMessage = "";
    private List<manufacturing_system.Models.EnvironmentalMonitor> recentReadings = new();
    private string currentLocation = "Davao City,PH";

    protected override async Task OnInitializedAsync()
    {
        await LoadFacilityLocation();
        await RefreshWeather();
        LoadRecentReadings();
    }

    private async Task LoadFacilityLocation()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            
            if (!string.IsNullOrEmpty(userId))
            {
                var user = DbContext.Users
                    .Where(u => u.Id == userId)
                    .Select(u => u.Facility)
                    .FirstOrDefault();

                if (user != null && !string.IsNullOrEmpty(user.Location))
                {
                    currentLocation = user.Location;
                }
            }
        }
        catch
        {
            // Use default location
        }
    }

    private async Task RefreshWeather()
    {
        isLoading = true;
        StateHasChanged();

        weatherData = await WeatherService.GetCurrentWeatherAsync(currentLocation);
        
        isLoading = false;
        StateHasChanged();
    }

    private async Task LogReading()
    {
        if (weatherData == null) return;

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            
            var user = DbContext.Users
                .Where(u => u.Id == userId)
                .FirstOrDefault();

            var reading = new manufacturing_system.Models.EnvironmentalMonitor
            {
                FacilityID = user?.FacilityID ?? 1,
                Temperature = weatherData.Temperature,
                Humidity = weatherData.Humidity,
                RecordedDate = DateTime.Now,
                AlertStatus = weatherData.GetAlertStatus()
            };

            DbContext.EnvironmentalMonitors.Add(reading);
            await DbContext.SaveChangesAsync();
            
            statusMessage = "Reading logged successfully!";
            LoadRecentReadings();
        }
        catch (Exception ex)
        {
            statusMessage = $"Error logging reading: {ex.Message}";
        }
    }

    private void LoadRecentReadings()
    {
        recentReadings = DbContext.EnvironmentalMonitors
            .OrderByDescending(r => r.RecordedDate)
            .Take(10)
            .ToList();
    }

    private string GetStatusClass() => weatherData?.GetAlertStatus() switch
    {
        "Critical" => "status-critical",
        "Warning" or "Cold Warning" or "High Humidity" => "status-warning",
        _ => "status-normal"
    };

    private string GetStatusIcon() => weatherData?.GetAlertStatus() switch
    {
        "Critical" => "bi-exclamation-triangle-fill",
        "Warning" or "Cold Warning" or "High Humidity" => "bi-exclamation-circle-fill",
        _ => "bi-check-circle-fill"
    };

    private string GetBadgeClass(string status) => status switch
    {
        "Critical" => "bg-danger",
        "Warning" or "Cold Warning" or "High Humidity" => "bg-warning text-dark",
        _ => "bg-success"
    };
}
